<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* CSS KHAS UNTUK CETAK BORANG KOSONG */
        @media print {
            .no-print { display: none !important; }
            body { background: white; -webkit-print-color-adjust: exact; }
            .print-border { border: 1px solid #000; padding: 10px; }
            
            /* Tukar input jadi garisan bila print kosong */
            .blank-form-mode input[type="text"], 
            .blank-form-mode textarea, 
            .blank-form-mode select {
                border: none;
                border-bottom: 1px solid #000;
                background: transparent;
                color: transparent; /* Hilangkan text placeholder */
                height: 30px;
            }
            .blank-form-mode ::placeholder { color: transparent; }
            .blank-form-mode .checkbox-wrapper label { margin-bottom: 15px; } /* Jarak untuk tick manual */
            
            /* Sembunyikan bahagian table rekod bila print borang */
            .blank-form-mode #recordTableSection { display: none; }
        }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #2563eb; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans text-sm">

    <div id="loginScreen" class="flex items-center justify-center min-h-screen">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
            <div class="text-center mb-6">
                <h1 class="text-2xl font-bold text-blue-900">Sistem Aduan Asrama</h1>
                <p class="text-gray-500">Log Masuk</p>
            </div>
            <form onsubmit="handleLogin(event)">
                <div class="mb-4">
                    <label class="block text-gray-700 font-bold mb-2">ID Pengguna</label>
                    <input type="text" id="loginId" class="w-full p-2 border rounded" placeholder="Masukkan ID">
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 font-bold mb-2">Kata Laluan</label>
                    <input type="password" id="loginPass" class="w-full p-2 border rounded" placeholder="Masukkan Kata Laluan">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700 font-bold">Log Masuk Admin</button>
            </form>
            <div class="mt-4 text-center border-t pt-4">
                <button onclick="enterAsGuest()" class="text-blue-500 hover:underline text-sm">Masuk sebagai Murid/Guest (Tanpa Login)</button>
            </div>
        </div>
    </div>

    <div id="appContainer" class="hidden max-w-5xl mx-auto p-4">
        
        <div class="flex justify-between items-center bg-white p-4 rounded-lg shadow mb-4 no-print">
            <h1 class="font-bold text-blue-900 text-lg">Sistem Asrama Pro</h1>
            <div class="flex gap-2">
                <button id="btnAdminPanel" onclick="showAdminPanel()" class="hidden bg-gray-700 text-white px-3 py-1 rounded text-xs"><i class="fas fa-cogs"></i> Tetapan Admin</button>
                <button onclick="logout()" class="bg-red-500 text-white px-3 py-1 rounded text-xs">Keluar</button>
            </div>
        </div>

        <div id="mainContent">
            
            <div class="grid grid-cols-3 gap-4 mb-6 no-print">
                <div class="bg-white p-4 rounded shadow text-center border-t-4 border-blue-500">
                    <div class="text-xs text-gray-500 uppercase font-bold">Jumlah</div>
                    <div id="statTotal" class="text-2xl font-bold">0</div>
                </div>
                <div class="bg-white p-4 rounded shadow text-center border-t-4 border-red-500">
                    <div class="text-xs text-gray-500 uppercase font-bold">Baru</div>
                    <div id="statPending" class="text-2xl font-bold text-red-600">0</div>
                </div>
                <div class="bg-white p-4 rounded shadow text-center border-t-4 border-green-500">
                    <div class="text-xs text-gray-500 uppercase font-bold">Selesai</div>
                    <div id="statDone" class="text-2xl font-bold text-green-600">0</div>
                </div>
            </div>

            <div id="formCard" class="bg-white rounded-lg shadow-lg mb-8 overflow-hidden">
                <div class="bg-blue-50 p-4 border-b flex justify-between items-center">
                    <h2 class="font-bold text-blue-900"><i class="fas fa-pen"></i> Borang Aduan</h2>
                    <div class="no-print space-x-2">
                        <button onclick="printBlankForm()" class="text-xs bg-gray-600 text-white px-2 py-1 rounded hover:bg-gray-800">Cetak Kosong (Manual)</button>
                        <button type="button" onclick="resetForm()" class="text-xs text-red-500 underline">Reset</button>
                    </div>
                </div>
                
                <form id="aduanForm" onsubmit="submitForm(this)" class="p-6">
                    <input type="hidden" name="recId" id="recId">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block font-bold text-xs uppercase mb-1">Nama Pelapor</label>
                            <input type="text" name="pelapor" id="pelapor" class="w-full border p-2 rounded" required placeholder="Nama Penuh">
                        </div>
                        <div>
                            <label class="block font-bold text-xs uppercase mb-1">Kategori</label>
                            <select name="kategori" id="kategori" onchange="renderDynamicFields()" class="w-full border p-2 rounded bg-white" required>
                                <option value="" disabled selected>- Pilih -</option>
                                <option value="Makanan">Makanan</option>
                                <option value="Kebersihan">Kebersihan</option>
                                <option value="Layanan">Layanan</option>
                            </select>
                        </div>
                    </div>

                    <div id="dynamicArea" class="mb-4 bg-gray-50 p-4 rounded border hidden">
                        <div id="waktuMakanDiv" class="hidden mb-3">
                            <label class="font-bold text-xs block mb-1">Waktu Makan</label>
                            <select name="waktuMakan" class="w-full border p-2 rounded">
                                <option value="Sarapan">Sarapan</option>
                                <option value="Tengahari">Tengahari</option>
                                <option value="Malam">Malam</option>
                            </select>
                        </div>
                        <label class="font-bold text-xs block mb-2">Tandakan Isu Berkaitan:</label>
                        <div id="checkboxContainer" class="grid grid-cols-2 gap-2 checkbox-wrapper"></div>
                    </div>

                    <div class="mb-4">
                        <label class="block font-bold text-xs uppercase mb-1">Catatan Tambahan</label>
                        <textarea name="catatan" id="catatan" rows="2" class="w-full border p-2 rounded"></textarea>
                    </div>

                    <div id="statusDiv" class="hidden mb-4 bg-yellow-50 p-2 border rounded">
                        <label class="block font-bold text-xs uppercase mb-1">Status Tindakan</label>
                        <select name="status" id="status" class="w-full border p-2 rounded">
                            <option value="Baru">Baru</option>
                            <option value="Dalam Tindakan">Dalam Tindakan</option>
                            <option value="Selesai">Selesai</option>
                        </select>
                    </div>

                    <div class="no-print">
                        <button type="submit" id="btnSubmit" class="bg-blue-600 text-white px-6 py-2 rounded font-bold hover:bg-blue-700 flex items-center gap-2">
                            <span>Hantar Laporan</span>
                            <div class="loader" id="loader"></div>
                        </button>
                    </div>
                </form>
            </div>

            <div id="recordTableSection" class="bg-white rounded-lg shadow overflow-hidden">
                <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                    <h2 class="font-bold">Senarai Laporan</h2>
                    <button onclick="window.print()" class="no-print text-xs bg-gray-200 px-2 py-1 rounded"><i class="fas fa-print"></i> Cetak Laporan</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="bg-gray-100 text-gray-600 text-xs uppercase border-b">
                                <th class="p-3">Tarikh</th>
                                <th class="p-3">Info</th>
                                <th class="p-3">Isu</th>
                                <th class="p-3">Status</th>
                                <th class="p-3 text-center no-print admin-only">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody" class="text-sm"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="adminPanel" class="hidden bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-xl font-bold mb-4 border-b pb-2">Panel Admin</h2>
            <button onclick="closeAdminPanel()" class="mb-4 text-sm text-blue-500">&larr; Kembali ke Dashboard</button>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-gray-50 p-4 rounded border">
                    <h3 class="font-bold text-gray-700 mb-2">Tukar ID & Password</h3>
                    <input type="text" id="newId" placeholder="ID Baru" class="w-full p-2 border mb-2 rounded">
                    <input type="password" id="newPass" placeholder="Password Baru" class="w-full p-2 border mb-2 rounded">
                    <button onclick="changeCreds()" class="bg-green-600 text-white px-4 py-1 rounded text-sm w-full">Simpan ID/Pass Baru</button>
                </div>

                <div class="bg-gray-50 p-4 rounded border">
                    <h3 class="font-bold text-gray-700 mb-2">Edit Kriteria Checklist</h3>
                    <div class="mb-2">
                        <label class="text-xs font-bold">Pilih Kategori:</label>
                        <select id="criteriaType" onchange="loadCriteriaEdit()" class="border p-1 rounded w-full">
                            <option value="makanan">Makanan</option>
                            <option value="kebersihan">Kebersihan</option>
                            <option value="layanan">Layanan</option>
                        </select>
                    </div>
                    <textarea id="criteriaListArea" rows="5" class="w-full p-2 border rounded text-sm" placeholder="Satu item per baris"></textarea>
                    <button onclick="saveCriteriaChanges()" class="bg-blue-600 text-white px-4 py-1 rounded text-sm mt-2 w-full">Simpan Kriteria</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        let IS_ADMIN = false;
        let CRITERIA_DATA = {};

        // --- AUTH ---
        function handleLogin(e) {
            e.preventDefault();
            const id = document.getElementById('loginId').value;
            const pass = document.getElementById('loginPass').value;
            
            google.script.run.withSuccessHandler(res => {
                if(res.success) {
                    IS_ADMIN = true;
                    initApp();
                } else {
                    alert("ID atau Kata Laluan Salah!");
                }
            }).login(id, pass);
        }

        function enterAsGuest() {
            IS_ADMIN = false;
            initApp();
        }

        function initApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');
            
            if(IS_ADMIN) {
                document.getElementById('btnAdminPanel').classList.remove('hidden');
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'table-cell');
            } else {
                 document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
            }

            loadAllData();
        }

        function logout() {
            location.reload();
        }

        // --- DATA LOADING ---
        function loadAllData() {
            // 1. Get Criteria
            google.script.run.withSuccessHandler(data => {
                CRITERIA_DATA = data;
            }).getCriteria();

            // 2. Get Reports
            google.script.run.withSuccessHandler(renderTable).getData();
        }

        function renderTable(data) {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            let stats = { total: data.length, pending: 0, done: 0 };

            data.forEach(row => {
                if(row.status === 'Selesai') stats.done++; else stats.pending++;
                
                const deleteBtn = IS_ADMIN ? `<button onclick="delData('${row.id}')" class="text-red-500 ml-2"><i class="fas fa-trash"></i></button>` : '';
                const editBtn = IS_ADMIN ? `<button onclick='editData(${JSON.stringify(row)})' class="text-blue-500"><i class="fas fa-edit"></i></button>` : '';
                const actionCol = IS_ADMIN ? `<td class="p-3 text-center no-print">${editBtn}${deleteBtn}</td>` : '';

                tbody.innerHTML += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-3 text-gray-500">${row.timestamp}</td>
                        <td class="p-3 font-bold">${row.kategori}<br><span class="text-xs font-normal text-gray-500">${row.waktuMakan}</span></td>
                        <td class="p-3 text-xs">${row.jenisIsu} <br> <i class="text-gray-400">"${row.catatan}"</i></td>
                        <td class="p-3"><span class="px-2 py-1 rounded text-xs font-bold ${row.status==='Selesai'?'bg-green-100 text-green-800':'bg-red-100 text-red-800'}">${row.status}</span></td>
                        ${actionCol}
                    </tr>
                `;
            });

            document.getElementById('statTotal').innerText = stats.total;
            document.getElementById('statPending').innerText = stats.pending;
            document.getElementById('statDone').innerText = stats.done;
        }

        // --- FORM LOGIC ---
        function renderDynamicFields() {
            const cat = document.getElementById('kategori').value;
            const container = document.getElementById('checkboxContainer');
            const area = document.getElementById('dynamicArea');
            const waktuDiv = document.getElementById('waktuMakanDiv');
            
            container.innerHTML = '';
            area.classList.remove('hidden');
            waktuDiv.classList.add('hidden');

            let list = [];
            if(cat === 'Makanan') {
                list = CRITERIA_DATA.makanan;
                waktuDiv.classList.remove('hidden');
            } else if(cat === 'Kebersihan') {
                list = CRITERIA_DATA.kebersihan;
            } else if(cat === 'Layanan') {
                list = CRITERIA_DATA.layanan;
            }

            list.forEach(item => {
                container.innerHTML += `<label class="flex items-center gap-2"><input type="checkbox" name="isu" value="${item}"> ${item}</label>`;
            });
        }

        function submitForm(form) {
            event.preventDefault();
            document.getElementById('btnSubmit').disabled = true;
            document.getElementById('loader').style.display = 'block';

            google.script.run.withSuccessHandler(res => {
                alert(res);
                resetForm();
                loadAllData();
                document.getElementById('btnSubmit').disabled = false;
                document.getElementById('loader').style.display = 'none';
            }).processForm(form);
        }

        function resetForm() {
            document.getElementById('aduanForm').reset();
            document.getElementById('recId').value = "";
            document.getElementById('dynamicArea').classList.add('hidden');
            document.getElementById('statusDiv').classList.add('hidden');
        }

        function editData(row) {
            document.getElementById('recId').value = row.id;
            document.getElementById('pelapor').value = row.pelapor;
            document.getElementById('kategori').value = row.kategori;
            renderDynamicFields(); // Render checkbox dulu
            
            // Set value dropdown/checkbox
            if(row.kategori === 'Makanan') document.querySelector('[name="waktuMakan"]').value = row.waktuMakan;
            
            // Tick checkbox
            if(row.jenisIsu) {
                row.jenisIsu.split(', ').forEach(val => {
                    const cb = document.querySelector(`input[value="${val}"]`);
                    if(cb) cb.checked = true;
                });
            }
            
            document.getElementById('catatan').value = row.catatan;
            document.getElementById('status').value = row.status;
            document.getElementById('statusDiv').classList.remove('hidden');
            
            document.getElementById('formCard').scrollIntoView({behavior:'smooth'});
        }

        function delData(id) {
            if(confirm('Padam data ini?')) {
                google.script.run.withSuccessHandler(loadAllData).deleteData(id);
            }
        }

        // --- PRINT BLANK FORM ---
        function printBlankForm() {
            document.body.classList.add('blank-form-mode');
            window.print();
            // Remove class selepas print dialog tutup (atau serta merta)
            setTimeout(() => {
                document.body.classList.remove('blank-form-mode');
            }, 1000);
        }

        // --- ADMIN SETTINGS ---
        function showAdminPanel() {
            document.getElementById('mainContent').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
        }
        function closeAdminPanel() {
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            loadAllData(); // Refresh in case criteria changed
        }

        function changeCreds() {
            const i = document.getElementById('newId').value;
            const p = document.getElementById('newPass').value;
            if(!i || !p) return alert("Sila isi kedua-dua ID dan Password");
            
            google.script.run.withSuccessHandler(alert).updateCredentials(i, p);
        }

        function loadCriteriaEdit() {
            const type = document.getElementById('criteriaType').value;
            let list = [];
            if(type === 'makanan') list = CRITERIA_DATA.makanan;
            if(type === 'kebersihan') list = CRITERIA_DATA.kebersihan;
            if(type === 'layanan') list = CRITERIA_DATA.layanan;
            
            document.getElementById('criteriaListArea').value = list.join('\n');
        }

        function saveCriteriaChanges() {
            const type = document.getElementById('criteriaType').value;
            const text = document.getElementById('criteriaListArea').value;
            const list = text.split('\n').filter(item => item.trim() !== "");
            
            google.script.run.withSuccessHandler(res => {
                alert(res);
                // Update local data
                if(type==='makanan') CRITERIA_DATA.makanan = list;
                if(type==='kebersihan') CRITERIA_DATA.kebersihan = list;
                if(type==='layanan') CRITERIA_DATA.layanan = list;
            }).saveCriteria(type, list);
        }
    </script>
</body>
</html>
